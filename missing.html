<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Missing Receipt Finder</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px 20px;
      background-color: #f0f4f8;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 30px;
    }

    .container {
      background: #fff;
      border-radius: 10px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    }

    .file-upload {
      margin-bottom: 20px;
    }

    input[type="file"] {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fafafa;
      width: 100%;
    }

    .buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    button {
      padding: 14px 28px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    button#checkBtn {
      background-color: #3498db;
    }

    button#clearBtn {
      background-color: #e74c3c;
    }

    button#downloadBtn {
      background-color: #f39c12;
    }

    button#copyBtn {
      background-color: #2ecc71;
    }

    button#toggleSQL {
      background-color: #9b59b6;
    }

    .output-box {
      margin-top: 30px;
      font-size: 16px;
      white-space: pre-wrap;
      color: #2c3e50;
      text-align: left;
      border: 1px solid #ccc;
      padding: 20px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-height: 500px;
      overflow-y: auto;
      transition: all 0.3s ease-in-out;
    }

    #sqlControls {
      margin-top: 20px;
      display: none;
      gap: 12px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    @media (max-width: 600px) {
      .buttons, #sqlControls {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <h1>Missing Receipt [#OR] Finder</h1>
  <div class="container">
    <div class="file-upload">
      <input type="file" id="fileInput" accept=".xls,.xlsx,.ods,.csv" multiple />
    </div>

    <div class="buttons">
      <button id="checkBtn" onclick="processFiles()">Check Missing</button>
      <button id="downloadBtn" style="display:none;">Download Result</button>
      <button id="clearBtn" onclick="clearOutput()">Clear Output</button>
    </div>

    <div id="output" class="output-box"></div>

    <div id="sqlControls">
      <button id="toggleSQL" onclick="toggleSQLVisibility()">Show SQL</button>
      <button id="copyBtn" onclick="copySQL()">Copy SQL</button>
    </div>

    <div id="sqlOutput" class="output-box" style="display:none;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    function processFiles() {
      const files = document.getElementById("fileInput").files;
      const output = document.getElementById("output");
      const downloadBtn = document.getElementById("downloadBtn");
      const sqlOutput = document.getElementById("sqlOutput");
      const sqlControls = document.getElementById("sqlControls");

      if (!files.length) {
        alert("Please select at least one file.");
        return;
      }

      output.textContent = "Processing files...\n";
      downloadBtn.style.display = "none";
      sqlOutput.style.display = "none";
      sqlControls.style.display = "none";

      let allMissing = {};
      let processedCount = 0;

      for (let file of files) {
        const reader = new FileReader();

        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          let receiptCol = -1;
          let dateCol = -1;
          let headerRowIndex = -1;

          for (let i = 0; i < json.length; i++) {
            const row = json[i];
            if (!row) continue;

            row.forEach((cell, colIndex) => {
              if (typeof cell === 'string' && cell.toLowerCase().includes("receipt")) {
                receiptCol = colIndex;
                headerRowIndex = i;
              }
              if (typeof cell === 'string' && cell.toLowerCase().includes("date")) {
                dateCol = colIndex;
              }
            });

            if (receiptCol !== -1 && dateCol !== -1) break;
          }

          if (receiptCol === -1 || dateCol === -1) {
            output.innerHTML += `Could not find 'Receipt#' or 'Date' in ${file.name}\n`;
            processedCount++;
            if (processedCount === files.length) finalizeOutput();
            return;
          }

          const rows = json.slice(headerRowIndex + 1);
          const groupedByDate = {};

          for (let row of rows) {
            const receipt = Number(row[receiptCol]);
            const date = row[dateCol];

            if (!date || isNaN(receipt)) continue;
            if (!groupedByDate[date]) groupedByDate[date] = [];
            groupedByDate[date].push(receipt);
          }

          for (let date in groupedByDate) {
            const receipts = groupedByDate[date].sort((a, b) => a - b);
            let missing = [];

            for (let i = 1; i < receipts.length; i++) {
              const prev = receipts[i - 1];
              const curr = receipts[i];
              for (let j = prev + 1; j < curr; j++) {
                missing.push(j);
              }
            }

            if (!allMissing[date]) allMissing[date] = [];
            allMissing[date] = allMissing[date].concat(missing);
          }

          processedCount++;
          if (processedCount === files.length) finalizeOutput();
        };

        reader.readAsArrayBuffer(file);
      }

      function finalizeOutput() {
        let message = `MISSING RECEIPT NUMBERS BY DATE\n\n`;
        let allMissingFlat = [];

        for (let date in allMissing) {
          const list = allMissing[date];
          if (list.length) {
            message += `${date}:\n${list.join(", ")}\n\n`;
            allMissingFlat.push(...list);
          }
        }

        if (allMissingFlat.length === 0) {
          message += "No missing receipt numbers found.";
          sqlOutput.style.display = "none";
          sqlControls.style.display = "none";
        } else {
          const uniqueSorted = [...new Set(allMissingFlat)].sort((a, b) => a - b);
          const formatted = uniqueSorted.map(n => `"${n}"`).join(", ");
          const sqlQuery = `SELECT * FROM pos_sale WHERE fdocument_no IN (${formatted});`;

          sqlOutput.textContent = "SQL Format:\n\n" + sqlQuery;
          sqlOutput.style.display = "none";
          sqlControls.style.display = "flex";
        }

        output.textContent = message;
        downloadBtn.style.display = "inline-block";

        downloadBtn.onclick = function () {
          const blob = new Blob([message], { type: "text/plain" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "missing_ORs_by_date.txt";
          link.click();
        };
      }
    }

    function clearOutput() {
      document.getElementById("output").textContent = "";
      document.getElementById("sqlOutput").textContent = "";
      document.getElementById("sqlOutput").style.display = "none";
      document.getElementById("sqlControls").style.display = "none";
      document.getElementById("downloadBtn").style.display = "none";
    }

    function toggleSQLVisibility() {
      const sql = document.getElementById("sqlOutput");
      const btn = document.getElementById("toggleSQL");
      if (sql.style.display === "none") {
        sql.style.display = "block";
        btn.textContent = "Hide SQL";
      } else {
        sql.style.display = "none";
        btn.textContent = "Show SQL";
      }
    }

    function copySQL() {
      const sql = document.getElementById("sqlOutput").textContent.replace("SQL Format:\n\n", "");
      navigator.clipboard.writeText(sql).then(() => {
        alert("SQL copied to clipboard!");
      });
    }
  </script>
</body>
</html>
